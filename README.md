# tinkoff-payments

Данный проект представляет собой пример внедрения интернет-эквайринга Тинькофф.

Разработчик принимал участие в разработке сайта по эквайрингу автомобилей в городе Сочи. В этом проекте, помимо рефакторинга существующей архитектуры, нужно было внедрить самую главную фичу - интернет-эквайринг.
Также заказ для успешной оплаты и подтверждения должен был пройти проверку. Проверка заключается в проверке пасспорта (наличие судимостей) и водительского удостоверения (ВУ, наличие штрафов). Этот функционал не включен в данный репозиторий.

В данном примере есть не самые лучше архитектурные решения (также касаемо дизайна базы данных), т.к. в реальной разарботке существуют сроки и закзачики, так что с некоторыми архитектурными решениями команды разработчику 
данного проекта приходилось мириться, уживаться и подстраиваться.

## Суть решения
Основная мысль заключалась в том, чтобы разобраться в API, предосталвяемое Тинькофф Банком, и продумать процесс обработки заказа. Само выражение "процесс обработки" наталкивает на мысль применить паттерн "Пайплайн", что разработчик сразу и решил сделать.

Очевидно, процесс обработки заказа довольно долгий по времени, поэтому запускать пайплайн необходимо в фоне, т.е. в асинхронной задаче.

Далее разработчик принял решение написать класс-клиент для взаимодсейтсвия с API банка (`apps/tinkoff_payments/services/core/api_client.py`), на котором и будет строиться вся дальнейшая архитектура.
Разработчик старался, как и всегда, сделать код максимально переиспользуемым, поэтому разделил код на 3 уровня:
- Инфраструктурный (views, models, middleware и т.д.).
- Сервисы, завязанные на инфраструктуре. Такие сервисы исползьуются внутри себя модели и другие вещи из инфраструктуры, поэтому просто скопировать их и вставить в новый проект не получится, но и не в этом их задача.
- Изолированные сервисы. Сервисы, которые можно просто скопировать в любой другой проект (даже не Django) и спокойно использовать.

В процессе работы с заказами подразумевалось вмешивание менеджера и самого клиента.

Функционал клиента:
- Создание заказа
- Отмена заказа
- Реинициализация заказа (если платежная сессия в существующем заказе истекла)

Функционал менеджера:
- Создание заказа
- Отмена заказа
- Реинициализация заказа (если платежная сессия в существующем заказе истекла)
- Отправка заказа на проверку
- Отправка клиенту СМС с платежной ссылкой
- Принудительное подтверждение заказа
- Завершение заказа

В связи с этим разработчик понимал, что для этого необходимо соответствующее API. В лучшем случае это API должно быть максимально тонким и опираться целиком и полностью на высокоуровневые сервисы.

## Архитектурное решение
Итак. Мы выяснили, что нам необходимо реализовать паттерн "Пайплайн". Пайплайн состоит из пайпов - простейших операций. По задумке разработчика работа с заказами должна проводиться исключительно через эти пайпы, т.к. пайпы, помимо выполнения бизнес-логики, отвечают еще и за проверку статуса заказа: перед выполнением операции пайп проверяет у обрабатываемого заказа его статус. Если статус заказа не позволяет выполнить пайп, будет выброшено исключение.

В некоторых пайпах необходимо работать с API банка. Для удобства разработчик создал высокоуровневые сервисы для этого:
- Сервис для отмены заказа (`apps/tinkoff_payments/payment_cancellation_service.py`).
- Сервис для подтверждения заказа (`apps/tinkoff_payments/payment_confirmation_service.py`).
- Сервис для инициализации платежной сессии с банком для заказа. Платежи можно совершать через карты и через СБП, и процесс инициализации платежной сессии отличается в этих двух случаях. Поэтому было принято применить паттерн "Стратегия" для каждого из этих случаев (`apps/tinkoff_payments/payment_initialization`).

Все пайпы используют внутри себя эти сервисы, а не напрямую клиент для работы с API. Некоторые из этих сервисов завязаны на архитектуре (инициализация платежа), но это нормально. Главное, что клиент является абсолютно переиспользуемым.

Схематично все вышеописанное можно представить так:
![uml](https://github.com/Sazoks/tinkoff-payments/assets/46415966/83046661-1d26-4f15-b7c0-2aa3ce457827)

Весь процесс обработки заказа выглядит так:
![Схема обработки заказа](https://github.com/Sazoks/tinkoff-payments/assets/46415966/52793b1e-285e-4dff-95d2-3bf2b492ad98)


